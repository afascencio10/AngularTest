angular.module("app",["ui.router","app.controllers","app.directives","app.services","chart.js"]),angular.module("app").config(function(i,t){i.state("home",{url:"/",templateUrl:"templates/home.html",controller:"homeCtrl"}).state("perfil_contratista",{url:"/contratista",templateUrl:"templates/contratista/perfil_contratista.html",controller:"perfil_contratista_ctrl"}).state("perfil_admin",{url:"/admin",templateUrl:"templates/admin/perfil_admin.html",controller:"perfil_admin_ctrl"}).state("contratista_admin",{url:"/admin/contratista",templateUrl:"templates/admin/contratista_admin.html",controller:"perfil_contratista_ctrl"}).state("perifl_observador",{url:"/admin/observador",templateUrl:"templates/admin/perfil_admin_observador.html",controller:"perfil_admin_ctrl"}),t.otherwise("/")}),angular.module("app.controllers",[]).controller("homeCtrl",["$scope","$state","$stateParams","homeServ",function(i,t,a,n){function o(a){i.tipo=a.data[0],"admin"==i.tipo.nombre?(t.go("perfil_admin"),window.sessionStorage.setItem("tipo",i.tipo.nombre),window.sessionStorage.setItem("id",i.perfil.id)):"contratista"==i.tipo.nombre?(t.go("perfil_contratista"),window.sessionStorage.setItem("tipo",i.tipo.nombre),window.sessionStorage.setItem("id",i.perfil.id)):"observador"==i.tipo.nombre&&(t.go("contratista_admin_observador"),window.sessionStorage.setItem("tipo",i.tipo.nombre),window.sessionStorage.setItem("id",i.perfil.id))}$(".modal").modal(),$(".collapsible").collapsible(),$("select").material_select(),"admin"==window.sessionStorage.tipo?t.go("perfil_admin"):"contratista"==window.sessionStorage.tipo&&t.go("perfil_contratista"),i.login=function(t,a){n.login(t,a).then(function(t){if(console.log(t),"Login Invalido"==t.data.id){var a=$("<span>Login Invalido, usuario o clave Incorrectos</span>");Materialize.toast(a,5e3)}else i.perfil=t.data,n.perfil(t.data.id).then(o)})}}]),angular.module("app.directives",[]).directive("footerHome",[function(){return{templateUrl:"templates/footer.html"}}]).directive("headerAdmin",[function(){return{templateUrl:"templates/admin/adminHeader.html"}}]).directive("searchBar",[function(){return{templateUrl:"templates/admin/modals/search.html"}}]).directive("controllerHeader",[function(){return{templateUrl:"templates/contratista/contratista_header.html"}}]).directive("headerObservador",[function(){return{templateUrl:"templates/admin/observadorHeader.html"}}]),angular.module("app.services",[]).factory("homeServ",function(i){var t="/api/cuentas";return{login:function(a,n){var o={usuario:a,clave:n};return i.post(t+"/login",o)},perfil:function(a){var n=t+"/"+a+"/perfiles";return i.get(n)}}}).factory("perfil_admin_serv",function(i){var t="/api/cuentas",a="/api/servicios",n="/api/servicios_vehiculos",o="/api/funciones",e="/api/perfiles",r="/api/perfil_cuenta",c="/api/localizaciones",u="/api/contratistas";return{getCuentas:function(){return i.get(t)},getContratista:function(){return i.get(u)},getCuentasContratista:function(t){var a=u+"/"+t+"/cuenta_contratista";return i.get(a)},getServiciosBrigadas:function(){return i.get(a)},getServiciosVehiculos:function(){return i.get(n)},getFuncionesTrabajadores:function(){return i.get(o)},getPerfiles:function(){return i.get(e)},getLocalizaciones:function(){return i.get(c)},postCuenta:function(a){return i.post(t,a)},postContratista:function(a,n){var o=t+"/"+a+"/contratista";return i.post(o,n)},postServicioBrigadas:function(t){return i.post(a,t)},postServicioVehiculos:function(t){return i.post(n,t)},postFuncionTrabajadores:function(t){return i.post(o,t)},postCrearPerfilCuenta:function(t){return i.post(r,t)},postLocalizaciones:function(t){return i.post(c,t)},updateServiciosBrigada:function(t){return i.put(a,t)},updateServicioVehiculo:function(t){return i.put(n,t)},updateFuncionTrabajador:function(t){return i.put(o,t)},updateLocalizacion:function(t){return i.put(c,t)},updateContratista:function(t){return i.put(u,t)},updateCuenta:function(a){return i.put(t,a)}}}).factory("perfil_contratista_serv",function(i){var t="/api/cuentas/",a="/api/contratistas",n="/api/vehiculos",o="/api/trabajadores",e="/api/brigadas",r="/api/contactos",c="/api/servicio_brigadas",u="/api/servicio_vehiculos",s="/api/funcion_trabajadors",d="/api/ubicacion_vehiculos",l="/api/ubicacion_trabajadores",f="/api/ubicacion_brigadas";return{getContratista:function(){var a=t+window.sessionStorage.id+"/contratista";return i.get(a)},getContactosContratista:function(t){var n=a+"/"+t+"/contactos";return i.get(n)},getVehiculosContratista:function(t){var n=a+"/"+t+"/vehiculos_contratista";return i.get(n)},getTrabajadroesContratista:function(t){var n=a+"/"+t+"/trabajadores_contratista";return i.get(n)},getBrigadasContratista:function(t){var n=a+"/"+t+"/brigadas_contratista";return i.get(n)},getServiciosBrigada:function(t){var a=e+"/"+t+"/servicio";return i.get(a)},getServiciosVehiculos:function(t){var a=n+"/"+t+"/servicio_veh?[filter][include][serviciosVehiculos]";return i.get(a)},getFuncionesTrabajador:function(t){var a=o+"/"+t+"/funciones_trabaj?[filter][include][funcion]";return i.get(a)},getUbicacionBrigada:function(t){var a=e+"/"+t+"/ubicacionBrigada";return i.get(a)},getUbicacionVehiculos:function(t){var a=n+"/"+t+"/ubicacionVeh?[filter][include][localizacion]";return i.get(a)},getUbicacionTrabajador:function(t){var a=o+"/"+t+"/ubicacionTrabaj?[filter][include][localizacion]";return i.get(a)},getUbicacionContacto:function(t){var a=r+"/"+t+"/ubicacionTrabaj";return i.get(a)},postContacto:function(t,n){var o=a+"/"+n+"/contactos";return i.post(o,t)},postVehiculo:function(t,n){var o=a+"/"+n+"/vehiculos_contratista";return i.post(o,t)},postTrabajador:function(t,n){var o=a+"/"+n+"/trabajadores_contratista";return i.post(o,t)},postBrigada:function(t,n){var o=a+"/"+n+"/brigadas_contratista";return i.post(o,t)},postServiciosBrigada:function(t){return i.post(c,t)},postServiciosVehiculos:function(t){return i.post(u,t)},postFuncionesTrabajador:function(t){return i.post(s,t)},postUbicacionBrigada:function(t){return i.post(f,t)},postUbicacionVehiculos:function(t){return i.post(d,t)},postUbicacionTrabajador:function(t){return i.post(l,t)},updateContacto:function(t){return i.put(r,t)},updateTrabajador:function(t){return i.put(o,t)},updateVehiculo:function(t){return i.put(n,t)},updateBrigada:function(t){return i.put(e,t)},updateServiciosBrigada:function(t){return i.put(c,t)},updateServiciosVehiculos:function(t){return i.put(u,t)},updateFuncionesTrabajador:function(t){return i.put(s,t)},updateUbicacionBrigada:function(t){return i.put(f,t)},updateUbicacionVehiculos:function(t){return i.put(d,t)},updateUbicacionTrabajador:function(t){return i.put(l,t)}}}).controller("perfil_contratista_ctrl",["$scope","$state","$stateParams","perfil_contratista_serv","perfil_admin_serv",function(i,t,a,n,o){function e(){n.getContratista().then(d),o.getServiciosVehiculos().then(r),o.getServiciosBrigadas().then(c),o.getFuncionesTrabajadores().then(u),o.getLocalizaciones().then(s)}function r(t){i.servicios_vehiculos=t.data}function c(t){i.servicios_brigadas=t.data}function u(t){i.funciones_trabajadores=t.data}function s(t){i.localizaciones=t.data}function d(t){i.contratista=t.data[0],n.getContactosContratista(i.contratista.id).then(b),n.getVehiculosContratista(i.contratista.id).then(l),n.getTrabajadroesContratista(i.contratista.id).then(p),n.getBrigadasContratista(i.contratista.id).then(v)}function l(t){i.vehiculos=t.data,_.forEach(i.vehiculos,f)}function f(i){n.getServiciosVehiculos(i.id).then(function(t){i.servicio=t.data[t.data.length-1]}),n.getUbicacionVehiculos(i.id).then(function(t){i.ubicacion=t.data[t.data.length-1]})}function p(t){i.trabajadores=t.data,_.forEach(i.trabajadores,h)}function h(i){n.getFuncionesTrabajador(i.id).then(function(t){i.funciones=_.filter(t.data,function(i){return null==i.fecha_fin})}),n.getUbicacionTrabajador(i.id).then(function(t){i.ubicacion=t.data[t.data.length-1]})}function v(t){i.brigadas=t.data,_.forEach(i.brigadas,g)}function g(i){n.getServiciosBrigada(i.id).then(function(t){i.servicio=t.data[t.data.length-1]}),n.getUbicacionBrigada(i.id).then(function(t){i.ubicacion=t.data[t.data.length-1]})}function b(t){i.contactos=t.data}$(".modal").modal(),$(".collapsible").collapsible(),$("select").material_select(),$(".datepicker").pickadate({selectMonths:!1,selectYears:40,today:"Today",clear:"Clear",close:"Ok",closeOnSelect:!0,formatSubmit:"yyyy/mm/dd"}),i.crearContacto=function(t){t.activo=!0,n.postContacto(t,i.contratista.id).then(e)},i.crearVehiculo=function(t){t.activo=!0,n.postVehiculo(t,i.contratista.id).then(function(i){var a={id_vehiculo:i.data.id,id_servicio_vehiculos:t.id_servicio};n.postServiciosVehiculos(a).then(e);var o={id_vehiculo:i.data.id,id_ubicacion:t.localizacion};n.postUbicacionVehiculos(o).then(e)})},i.crearTrabajador=function(t){n.postTrabajador(t,i.contratista.id).then(function(i){var a={tipo:"Principal",id_funcion:t.funcionP.id_funcion,id_trabajador:i.data.id,fecha_inicio:new Date};if(n.postFuncionesTrabajador(a).then(e),t.funcion2.id_funcion){var o={tipo:"Secundaria",id_funcion:t.funcion2.id_funcion,id_trabajador:i.data.id,fecha_inicio:new Date};n.postFuncionesTrabajador(o).then(e)}if(t.funcion3.id_funcion){var r={tipo:"Tercera",id_funcion:t.funcion3.id_funcion,id_trabajador:i.data.id,fecha_inicio:new Date};n.postFuncionesTrabajador(r).then(e)}var c={id_trabajador:i.data.id,id_ubicacion:t.localizacion};n.postUbicacionTrabajador(c).then(e)})},i.crearBrigada=function(t){n.postBrigada(t,i.contratista.id).then(function(i){var a={id_servicio:t.id_servicio,id_brigada:i.data.id};n.postServiciosBrigada(a).then(e);var o={id_brigada:i.data.id,id_ubicacion:t.localizacion};n.postUbicacionBrigada(o).then(e)})},i.editContacto=function(t){i.editing=!0,i.contacto=t,$("#conctacto").modal("open")},i.editBrigada=function(t){i.editing=!0,i.brigada=t,$("#brigada").modal("open")},i.editVehiculo=function(t){i.editing=!0,i.vehiculo=t,$("#vehiculo").modal("open")},i.editTrabajador=function(t){i.editing=!0,i.trabajador=t,$("#trabajador").modal("open")},i.updateContacto=function(t){i.editing=!1,i.contacto={},n.updateContacto(t).then(e)},i.updateTrabajador=function(t){if(i.editing=!1,i.trabajador={},n.updateTrabajador(t).then(e),t.funcionP&&t.funciones[0].id_funcion!=t.funcionP.id_funcion){var a={tipo:"Principal",id_funcion:t.funcionP.id_funcion,id_trabajador:t.id,fecha_inicio:new Date},o=t.funciones[0];o.fecha_fin=new Date,n.updateFuncionesTrabajador(o),n.postFuncionesTrabajador(a).then(e)}if(t.funciones[1]&&t.funcion2&&t.funciones[1].id_funcion!=t.funcion2.id_funcion){var a={tipo:"Secundaria",id_funcion:t.funcion2.id_funcion,id_trabajador:t.id,fecha_inicio:new Date},o=t.funciones[1];o.fecha_fin=new Date,n.updateFuncionesTrabajador(o),n.postFuncionesTrabajador(a).then(e)}if(t.funciones[2]&&t.funcion3&&t.funciones[2].id_funcion!=t.funcion3.id_funcion){var a={tipo:"Tercera",id_funcion:t.funcion3.id_funcion,id_trabajador:t.id,fecha_inicio:new Date},o=t.funciones[2];o.fecha_fin=new Date,n.updateFuncionesTrabajador(o),n.postFuncionesTrabajador(a).then(e)}if(t.localizacion&&t.ubicacion.id_ubicacion!=t.localizacion){var r={id_trabajador:t.id,id_ubicacion:t.localizacion},c={id:t.ubicacion.id,id_trabajador:t.id,id_ubicacion:t.ubicacion.id_ubicacion,activo:!1};n.postUbicacionTrabajador(r),n.updateUbicacionTrabajador(c).then(e)}},i.updateVehiculo=function(t){if(i.editing=!1,i.vehiculo={},n.updateVehiculo(t).then(e),t.localizacion&&t.ubicacion&&t.ubicacion.id_ubicacion!=t.localizacion){var a={id_vehiculo:t.id,id_ubicacion:t.localizacion},o={id:t.ubicacion.id,id_vehiculo:t.id,id_ubicacion:t.ubicacion.id_ubicacion,activo:!1};n.postUbicacionVehiculos(a),n.updateUbicacionVehiculos(o).then(e)}else if(!t.ubicacion&&t.localizacion){var a={id_vehiculo:t.id,id_ubicacion:t.localizacion};n.postUbicacionVehiculos(a).then(e)}if(t.id_servicio&&t.id_servicio!=t.servicio.id_servicio_vehiculos){var r={id_vehiculo:t.id,id_servicio_vehiculos:t.id_servicio},c={id_vehiculo:t.id,id_servicio_vehiculos:t.servicio.id_servicio_vehiculos,activio:!1};n.postServiciosVehiculos(r),n.updateServiciosVehiculos(c).then(e)}},i.updateBrigada=function(t){i.editing=!1,i.brigada={},n.updateBrigada(t).then(e)},e(),i.patchContratista=function(i){},i.cerrarSession=function(){window.sessionStorage.clear(),t.go("home")}}]).controller("perfil_admin_ctrl",["$scope","$state","$stateParams","perfil_admin_serv",function(i,t,a,n){function o(){n.getCuentas().then(e),n.getServiciosVehiculos().then(r),n.getServiciosBrigadas().then(c),n.getFuncionesTrabajadores().then(u),n.getPerfiles().then(s),n.getLocalizaciones().then(d),n.getContratista().then(l)}function e(t){i.cuentas=t.data}function r(t){i.servicios_vehiculos=t.data}function c(t){i.servicios_brigadas=t.data}function u(t){i.funciones_trabajadores=t.data}function s(t){i.perfiles=t.data}function d(t){i.localizaciones=t.data}function l(t){i.contratistas=t.data,_.forEach(i.contratistas,f)}function f(i){n.getCuentasContratista(i.id).then(function(t){i.cuentas=t.data})}$(".modal").modal(),$(".collapsible").collapsible(),$("select").material_select(),i.seeContratista=function(i){window.sessionStorage.setItem("id",i),t.go("contratista_admin")},i.crearCuenta=function(i){n.postCuenta(i).then(function(t){var a={id_cuenta:t.data.id,id_perfil:i.perfil};if(n.postCrearPerfilCuenta(a).then(o),2==i.perfil){var e={rut:i.rut,nombre:i.nombre,razon_social:i.razon_social};n.postContratista(t.data.id,e).then(o)}})},i.crearServicioBrigada=function(i){n.postServicioBrigadas(i).then(o)},i.crearServicioVehiculo=function(i){n.postServicioVehiculos(i).then(o)},i.crearFuncionTrabajador=function(i){n.postFuncionTrabajadores(i).then(o)},i.crearLocalizacion=function(i){n.postLocalizaciones(i).then(o)},i.editLocalizacion=function(t){i.editing=!0,i.localizacion=t,$("#localizaciones").modal("open")},i.editServicioBrigadas=function(t){i.editing=!0,i.servicio=t,$("#servicioBrigadas").modal("open")},i.editServiciosVehiculos=function(t){i.editing=!0,i.servicio=t,$("#servicioVehiculos").modal("open")},i.editFuncionesTrab=function(t){i.editing=!0,i.servicio=t,$("#servicioTrabajadores").modal("open")},i.updateServiciosBrigada=function(t){i.editing=!1,i.servicio={},n.updateServiciosBrigada(t).then(o)},i.updateServicioVehiculo=function(t){i.editing=!1,i.servicio={},n.updateServicioVehiculo(t).then(o)},i.updateFuncionTrabajador=function(t){i.editing=!1,i.servicio={},n.updateFuncionTrabajador(t).then(o)},i.updateLocalizacion=function(t){i.editing=!1,i.localizacion={},n.updateLocalizacion(t).then(o)},i.editContratista=function(t){i.editing=!0,i.contat=t,t.cuentas&&(i.editingCont=t.cuentas.length),$("#contrat").modal("open")},i.updateContratista=function(t){i.contat={},i.editing=!1,n.updateContratista(t).then(o),_.forEach(t.cuentas,function(i){n.updateCuenta(i).then(o)})},i.crearContratista=function(i){_.forEach(i.cuentas,function(i,t){n.postCuenta(i).then(function(a){var e={id_cuenta:a.data.id,id_perfil:i.perfil};if(n.postCrearPerfilCuenta(e).then(o),2==i.perfil&&1==t){var r={rut:r.rut,nombre:r.nombre,razon_social:r.razon_social};n.postContratista(a.data.id,r).then(o)}})})},o(),i.cerrarSession=function(){window.sessionStorage.clear(),t.go("home")}}]);